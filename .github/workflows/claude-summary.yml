name: Claude Summary

on:
  push:
    branches: [ master ]
    paths-ignore: [ 'SUMMARY.md' ]

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with: { fetch-depth: 2 }

    - uses: actions/setup-node@v4
      with: { node-version: 20 }

    - run: npm install -g @anthropic-ai/claude-code

    - name: Load CLAUDE_API_KEY
      run: echo "CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}" >> \$GITHUB_ENV

    - name: Create summary
      run: |
        git log -1 --pretty=format:"%h - %s" > commit.txt
        if [ "\$(git rev-list --count HEAD)" -gt 1 ]; then
          git diff HEAD~1..HEAD >> commit.txt
        fi
        PROMPT="住 注专转  拽爪专:\n\n\$(cat commit.txt)"
        echo -e "\$PROMPT" | claude chat > SUMMARY.md

    - name: Commit summary
      env: { GITHUB_TOKEN: \${{ github.token }} }
      run: |
        git config --global user.name  "claude-bot"
        git config --global user.email "bot@users.noreply.github.com"
        git add SUMMARY.md
        git commit -m "docs: auto summary by Claude " || echo "No changes"
        git push
