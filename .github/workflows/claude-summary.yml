name: Claude Summary

on:
  push:
    branches: [ master ]
    paths-ignore:
      - 'SUMMARY.md'

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout (שני קומיטים לדיפ)
    - uses: actions/checkout@v4
      with: { fetch-depth: 2 }

    # 2) מתקינים jq (פירוק JSON) ו-curl כבר קיים
    - run: sudo apt-get update && sudo apt-get install -y jq

    # 3) Load API key כסוד
    - name: Load CLAUDE_API_KEY
      run: echo "CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}" >> $GITHUB_ENV

    # 4) יוצרים commit.txt ומבקשים מ-Claude סיכום
    - name: Create summary
      run: |
        # כותרת הקומיט האחרון
        git log -1 --pretty=format:"%h - %s" > commit.txt
        # דיפ אם יש יותר מקומיט אחד
        if [ "$(git rev-list --count HEAD)" -gt 1 ]; then
          git diff HEAD~1..HEAD >> commit.txt
        fi

        # בונים את הפרומפט
        PROMPT="סכם בעברית בבולטים קצרים את השינויים הבאים:\n\n$(cat commit.txt)"

        # בקשת API
        curl https://api.anthropic.com/v1/messages \
          -H "x-api-key: $CLAUDE_API_KEY" \
          -H "anthropic-version: 2023-06-01" \
          -H "content-type: application/json" \
          -d @- <<CURL_EOF | jq -r '.content[0].text' > SUMMARY.md
{
  "model": "claude-3-sonnet-20240229",
  "max_tokens": 256,
  "messages": [
    { "role": "user", "content": "$PROMPT" }
  ]
}
CURL_EOF

    # 5) Commit & push
    - name: Commit summary
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        git config --global user.name  "claude-bot"
        git config --global user.email "bot@users.noreply.github.com"
        git add SUMMARY.md
        git commit -m "docs: auto summary by Claude 🤖" || echo "No changes"
        git push