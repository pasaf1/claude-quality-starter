name: Claude Summary

on:
  push:
    branches: [ master ]          # ×©× ×” ×œ-main ×× ×–×” ×”×¢× ×£ ×”×¢×™×§×¨×™
    paths-ignore:
      - 'SUMMARY.md'              # ×œ× ×œ×”×¤×¢×™×œ ×¢×œ ×§×•×‘×¥ ×”×¡×™×›×•× ×¢×¦××•

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout ×¢× ×©× ×™ ×§×•××™×˜×™× ××—×•×¨×”
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2            # × ×“×¨×©×™× ×©× ×™ ×§×•××™×˜×™× ×œ×“×™×¤

    # 2) ×”×ª×§× ×ª Node
    - uses: actions/setup-node@v4
      with:
        node-version: 20

    # 3) ×”×ª×§× ×ª Claude CLI
    - run: npm install -g @anthropic-ai/claude-code

    # 4) ×˜×¢×™× ×ª ××¤×ª×— Claude ×›××©×ª× ×”-×¡×‘×™×‘×”
    - name: Load CLAUDE_API_KEY
      run: echo "CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}" >> $GITHUB_ENV

    # 5) ×™×¦×™×¨×ª commit.txt ×•×¡×™×›×•×
    - name: Create summary
      run: |
        git log -1 --pretty=format:"%h - %s" > commit.txt
        if [ "$(git rev-list --count HEAD)" -gt 1 ]; then
          git diff HEAD~1..HEAD >> commit.txt
        fi

        claude code . \
          --command "×¡×›× ×‘×¢×‘×¨×™×ª (bullet-list ×§×¦×¨) ××ª ×§×•×‘×¥ commit.txt." \
          --input commit.txt > SUMMARY.md

    # 6) ×§×•××™×˜ ×•×¤×•×© ×©×œ SUMMARY.md
    - name: Commit summary
      env:
        # ×× ×œ× ×”×’×“×¨×ª GH_TOKEN â€“ github.token ×”××•×‘× ×” ×™×¡×¤×™×§
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
      run: |
        git config --global user.name  "claude-bot"
        # ××¤×©×¨ ×œ×”×—×œ×™×£ ×œ×›×ª×•×‘×ª ×”× ×•×¨×™×¤×œ×™×™ ×©×œ GitHub ×©×œ×š:
        # git config --global user.email "123456+USERNAME@users.noreply.github.com"
        git config --global user.email "claude@example.com"
        git add SUMMARY.md
        git commit -m "docs: auto summary by Claude ğŸ¤–" || echo "No changes"
        git push
